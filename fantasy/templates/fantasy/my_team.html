{% extends 'base.html' %}
{% load static %}
{% load fantasy_extras %}

{% block content %}
<div class="w-full max-w-7xl mx-auto text-white py-5 px-4">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-white text-center sm:text-left">{{ team.name }}</h1>
        <p class="text-gray-400 text-center sm:text-left">Manage your squad for {{ league.name }}</p>
    </div>

    <!-- Top Info Bar -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <a href="{% url 'fantasy:league_detail' league.id %}" class="text-sm font-medium text-indigo-400 hover:text-indigo-300 transition-colors duration-200">
                &larr; Back to League
            </a>
        </div>
        <div class="flex items-center gap-6 text-gray-300 text-sm">
            <div>
                Balance: <span class="font-semibold text-white">£{{ team.balance|floatformat:1 }}m</span>
            </div>
            {% if transfers_left is not None %}
            <div>
                Transfers Left: <span class="font-semibold text-white">{{ transfers_left }}</span>
            </div>
            {% endif %}
            {% if current_week %}
            <div>
                Gameweek {{current_week.index}} Deadline: <span class="font-semibold text-white">{{ current_week.deadline_at|date:"d M H:i" }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- Left Column: Pitch View -->
        <div class="lg:col-span-3 bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-cover bg-center p-4 space-y-4" style="background-image:url('{% static 'images/pitch_background.jpg' %}');">
                
                <!-- Goalkeepers (1) -->
                {% with goalkeepers=active_players|filter_by_position:'GK' %}
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2 text-center opacity-80">Goalkeepers</h3>
                    <div class="flex justify-center gap-4">
                        {% if goalkeepers.0 %}
                            {% include 'fantasy/partials/player_card.html' with fp=goalkeepers.0 deadline_open=deadline_open %}
                        {% else %}
                            {% include 'fantasy/partials/empty_player_card.html' %}
                        {% endif %}
                    </div>
                </div>
                {% endwith %}

                <!-- Defenders (4) -->
                {% with defenders=active_players|filter_by_position:'DF' %}
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2 text-center opacity-80">Defenders</h3>
                    <div class="flex justify-center gap-4 flex-wrap">
                        {% for i in "1234" %}
                            {% with player=defenders|get_at_index:forloop.counter0 %}
                                {% if player %}
                                    {% include 'fantasy/partials/player_card.html' with fp=player deadline_open=deadline_open %}
                                {% else %}
                                    {% include 'fantasy/partials/empty_player_card.html' %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endwith %}

                <!-- Midfielders (3) -->
                {% with midfielders=active_players|filter_by_position:'MF' %}
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2 text-center opacity-80">Midfielders</h3>
                    <div class="flex justify-center gap-4 flex-wrap">
                        {% for i in "123" %}
                            {% with player=midfielders|get_at_index:forloop.counter0 %}
                                {% if player %}
                                    {% include 'fantasy/partials/player_card.html' with fp=player deadline_open=deadline_open %}
                                {% else %}
                                    {% include 'fantasy/partials/empty_player_card.html' %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endwith %}

                <!-- Forwards (3) -->
                {% with forwards=active_players|filter_by_position:'FW' %}
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2 text-center opacity-80">Forwards</h3>
                    <div class="flex justify-center gap-4 flex-wrap">
                        {% for i in "123" %}
                            {% with player=forwards|get_at_index:forloop.counter0 %}
                                {% if player %}
                                    {% include 'fantasy/partials/player_card.html' with fp=player deadline_open=deadline_open %}
                                {% else %}
                                    {% include 'fantasy/partials/empty_player_card.html' %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endwith %}
            </div>
            <!-- Bench (4) -->
            <div class="bg-gray-900/80 p-4">
                <h3 class="text-lg font-semibold text-white mb-3 text-center">Bench</h3>
                <div class="flex justify-center gap-4 flex-wrap">
                    {% with subs=substitute_players %}
                         {% for i in "1234" %}
                            {% with player=subs|get_at_index:forloop.counter0 %}
                                {% if player %}
                                    {% include 'fantasy/partials/player_card.html' with fp=player deadline_open=deadline_open is_bench=True %}
                                {% else %}
                                    {% include 'fantasy/partials/empty_player_card.html' %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>

        <!-- Right Column: Player List & Filters -->
        <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-xl p-4 md:p-6">
            <h2 class="text-xl font-bold mb-4 text-white">Transfer Market</h2>
            <!-- Filters -->
            <form method="get" class="mb-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input name="q" value="{{ filter_q }}" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="Search by name...">
                    <select name="position" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                        <option value="">All Positions</option>
                        {% for code,label in position_choices %}
                        <option value="{{ code }}" {% if filter_position == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <button class="w-full mt-4 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" type="submit">Filter Players</button>
            </form>

            <!-- Player List -->
            <div class="space-y-2 h-96 overflow-y-auto pr-2">
                 {% for p in available_players %}
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <div>
                        <div class="font-bold text-white">{{ p.first_name }} {{ p.last_name }}</div>
                        <div class="text-sm text-gray-400">{{ p.real_team.name }} - {{ p.get_position_display }}</div>
                    </div>
                    <div class="text-right">
                         <div class="font-bold text-white">£{{ p.price|floatformat:1 }}m</div>
                         <form method="post" class="mt-1">
                            {% csrf_token %}
                            <input type="hidden" name="add_player" value="1" />
                            <input type="hidden" name="player_id" value="{{ p.id }}" />
                            <button type="submit" class="px-3 py-1 text-xs bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 {% if not deadline_open %}opacity-50 cursor-not-allowed{% endif %}" {% if not deadline_open %}disabled{% endif %}>
                                Add
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div class="text-gray-500 p-4 text-center">No players match your search.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if not team %}
     <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 text-center shadow-2xl">
            <p class="text-gray-300 mb-4 text-lg">You don't have a team in this league yet.</p>
            <form method="post" class="max-w-sm mx-auto">
                {% csrf_token %}
                <input type="hidden" name="create_team" value="1" />
                <div class="flex items-center gap-3">
                    <input type="text" name="name" placeholder="Enter Your Team Name" class="bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3" required />
                    <button type="submit" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-500 font-semibold rounded-lg text-sm px-5 py-3 text-center">
                        Create Team
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<!-- NOTE: You will need to create these new partial templates and a custom template tag -->

<!-- 1. Create a new file: fantasy/partials/empty_player_card.html -->
<!--
<div class="w-20 h-32 bg-gray-700/50 rounded-lg flex items-center justify-center text-gray-400 text-center border-2 border-dashed border-gray-600">
    <span class="text-sm">Empty</span>
</div>
-->


<!-- 2. Update your existing file: fantasy/partials/player_card.html -->
<!-- Make sure to handle the 'is_bench' variable for bench players -->
<!--
<div class="w-20 text-center">
    <div class="relative">
        <img src="{% static 'images/player_default.png' %}" alt="{{ fp.player.last_name }}" class="w-full h-auto rounded-t-md">
        <div class="absolute top-0 right-0 flex gap-1 p-1">
            {% if fp.is_captain %}
            <span class="flex items-center justify-center w-5 h-5 text-xs bg-yellow-500 text-black font-bold rounded-full">C</span>
            {% endif %}
            {% if fp.is_vice_captain %}
            <span class="flex items-center justify-center w-5 h-5 text-xs bg-gray-400 text-black font-bold rounded-full">V</span>
            {% endif %}
        </div>
    </div>
    <div class="bg-gray-900 p-1 rounded-b-md">
        <p class="text-white text-sm font-semibold truncate">{{ fp.player.last_name }}</p>
        <p class="text-gray-400 text-xs">£{{ fp.price_at_purchase|floatformat:1 }}m</p>
    </div>
    {% if not is_bench %}
    <div class="mt-1 flex justify-center gap-1">
         <form method="post" class="inline-block">
            {% csrf_token %}
            <input type="hidden" name="set_captain" value="1" />
            <input type="hidden" name="fantasy_player_id" value="{{ fp.id }}" />
            <button title="Make Captain" type="submit" class="px-1.5 py-0.5 text-xs bg-yellow-600 text-white rounded hover:bg-yellow-700 {% if not deadline_open or fp.is_captain %}opacity-50 cursor-not-allowed{% endif %}" {% if not deadline_open or fp.is_captain %}disabled{% endif %}>C</button>
        </form>
         <form method="post" class="inline-block">
            {% csrf_token %}
            <input type="hidden" name="set_vice_captain" value="1" />
            <input type="hidden" name="fantasy_player_id" value="{{ fp.id }}" />
            <button title="Make Vice-Captain" type="submit" class="px-1.5 py-0.5 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 {% if not deadline_open or fp.is_vice_captain %}opacity-50 cursor-not-allowed{% endif %}" {% if not deadline_open or fp.is_vice_captain %}disabled{% endif %}>V</button>
        </form>
        <form method="post" class="inline-block">
            {% csrf_token %}
            <input type="hidden" name="remove_player" value="1" />
            <input type="hidden" name="fantasy_player_id" value="{{ fp.id }}" />
            <button title="Remove Player" type="submit" class="px-1.5 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700 {% if not deadline_open %}opacity-50 cursor-not-allowed{% endif %}" {% if not deadline_open %}disabled{% endif %}>X</button>
        </form>
    </div>
    {% endif %}
</div>
-->

<!-- 3. Create a new custom template tag to get items from a list by index -->
<!-- In your fantasy_extras.py file, add the following:
from django import template

register = template.Library()

@register.filter
def get_at_index(list, index):
    if list and 0 <= index < len(list):
        return list[index]
    return None

# ... other filters ...
-->

{% endblock %}
